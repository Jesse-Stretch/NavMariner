
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NavMariner Lite</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b1e2d;
  color: white;
}
#topBar {
  padding: 8px;
  background: #102a44;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}
input, button {
  padding: 6px;
  border-radius: 4px;
  border: none;
}
button {
  background: #ffcc00;
  cursor: pointer;
}
button.active {
  background: #4caf50;
}
#coords {
  font-size: 13px;
}
#info {
  padding: 8px;
  background: #081724;
  font-size: 14px;
}
#map {
  height: calc(100vh - 170px);
}
</style>
</head>

<body>

<div id="topBar">
  <button onclick="locateMe()">ğŸ“ Locate</button>
  <button id="followBtn" onclick="toggleFollow()">ğŸ§­ Follow</button>

  Speed:
  <input id="speedInput" type="number" value="20" style="width:60px">kts

  Lat:<input id="latInput" type="number" step="any" style="width:95px">
  Lon:<input id="lonInput" type="number" step="any" style="width:105px">

  <button onclick="addCoordWaypoint()">â• WP</button>
  <button onclick="undoLast()">â†© Undo</button>
  <button onclick="clearRoute()">ğŸ—‘ Clear</button>

  <input id="routeName" placeholder="Route name" style="width:120px">
  <button onclick="saveRoute()">ğŸ’¾ Save</button>
  <button onclick="loadRoute()">ğŸ“‚ Load</button>

  <span id="coords">Cursor: -- , --</span>
</div>

<div id="info">
  Distance: <span id="distance">0.00</span> NM |
  ETA: <span id="eta">0</span> min |
  Bearing: <span id="bearing">--</span>Â°
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map', { dragging: false }).setView([49.2827, -123.1207], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);

let waypoints = [];
let markers = [];
let routeLine = L.polyline([], { color:'yellow' }).addTo(map);
let previewLine = L.polyline([], { color:'yellow', dashArray:'5,5' }).addTo(map);

let followMode=false, currentMarker=null, workingBounds=null;
let pressTimer=null, isDragging=false;

function locateMe(){ map.locate({setView:true,maxZoom:14}); }
function toggleFollow(){
  followMode=!followMode;
  followBtn.classList.toggle("active",followMode);
}

map.on('locationfound',e=>{
  if(!currentMarker) currentMarker=L.marker(e.latlng).addTo(map);
  else currentMarker.setLatLng(e.latlng);

  if(!workingBounds){
    workingBounds=L.latLngBounds(
      [e.latlng.lat-0.3,e.latlng.lng-0.3],
      [e.latlng.lat+0.3,e.latlng.lng+0.3]
    );
    map.setMaxBounds(workingBounds);
  }
  if(followMode) map.setView(e.latlng);
});

const mapEl=map.getContainer();
mapEl.addEventListener('mousedown',startPress);
mapEl.addEventListener('touchstart',startPress);
mapEl.addEventListener('mouseup',endPress);
mapEl.addEventListener('touchend',endPress);

function startPress(){
  isDragging=false;
  pressTimer=setTimeout(()=>{
    isDragging=true;
    map.dragging.enable();
  },300);
}

function endPress(e){
  clearTimeout(pressTimer);
  map.dragging.disable();
  if(isDragging) return;
  const latlng=map.mouseEventToLatLng(e.changedTouches?e.changedTouches[0]:e);
  addWaypoint(latlng.lat,latlng.lng);
}

function addCoordWaypoint(){
  let lat=parseFloat(latInput.value), lon=parseFloat(lonInput.value);
  if(isNaN(lat)||isNaN(lon)) return;
  addWaypoint(lat,lon);
}

function addWaypoint(lat,lon){
  let pt=[lat,lon];
  waypoints.push(pt);
  markers.push(L.circleMarker(pt,{radius:6,color:'red'}).addTo(map));
  routeLine.setLatLngs(waypoints);
  updateStats();
}

function undoLast(){
  if(!waypoints.length) return;
  waypoints.pop();
  map.removeLayer(markers.pop());
  routeLine.setLatLngs(waypoints);
  updateStats();
}

function clearRoute(){
  waypoints=[];
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  routeLine.setLatLngs([]);
  previewLine.setLatLngs([]);
  updateStats();
}

function updateStats(){
  let meters=0;
  for(let i=1;i<waypoints.length;i++) meters+=map.distance(waypoints[i-1],waypoints[i]);
  let nm=meters/1852;
  let speed=parseFloat(speedInput.value)||1;
  distance.innerText=nm.toFixed(2);
  eta.innerText=Math.round((nm/speed)*60);

  if(waypoints.length>1){
    let a=waypoints[waypoints.length-2], b=waypoints[waypoints.length-1];
    let brg=(Math.atan2(
      Math.sin((b[1]-a[1])*Math.PI/180)*Math.cos(b[0]*Math.PI/180),
      Math.cos(a[0]*Math.PI/180)*Math.sin(b[0]*Math.PI/180)-
      Math.sin(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.cos((b[1]-a[1])*Math.PI/180)
    )*180/Math.PI+360)%360;
    bearing.innerText=brg.toFixed(0);
  } else bearing.innerText="--";
}

speedInput.addEventListener("input",updateStats);

map.on('mousemove',e=>{
  coords.innerText=`Cursor: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
  if(waypoints.length) previewLine.setLatLngs([waypoints.at(-1),e.latlng]);
  autoPan(e);
});

function autoPan(e){
  let b=map.getBounds(), p=0.15, dx=0, dy=0;
  if(e.latlng.lat>b.getNorth()-(b.getNorth()-b.getSouth())*p) dy=-20;
  if(e.latlng.lat<b.getSouth()+(b.getNorth()-b.getSouth())*p) dy=20;
  if(e.latlng.lng>b.getEast()-(b.getEast()-b.getWest())*p) dx=20;
  if(e.latlng.lng<b.getWest()+(b.getEast()-b.getWest())*p) dx=-20;
  if(dx||dy) map.panBy([dx,dy],{animate:false});
}

function saveRoute(){
  if(!routeName.value) return;
  localStorage.setItem("nav_"+routeName.value,JSON.stringify(waypoints));
}

function loadRoute(){
  if(!routeName.value) return;
  let data=localStorage.getItem("nav_"+routeName.value);
  if(!data) return;
  clearRoute();
  JSON.parse(data).forEach(p=>addWaypoint(p[0],p[1]));
}
</script>

</body>
</html>
